<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pronósticos Diarios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Importar las bibliotecas de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables globales proporcionadas por el entorno de Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userId = null;

        const forecastForm = document.getElementById('forecast-form');
        const forecastInput = document.getElementById('forecast-input');
        const forecastsList = document.getElementById('forecasts-list');
        const loadingIndicator = document.getElementById('loading-indicator');
        const userDisplay = document.getElementById('user-display');
        const modal = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');
        const closeModalButton = document.getElementById('close-modal');

        // Función para mostrar el modal de notificación
        function showModal(message) {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }

        // Cargar el token de autenticación
        async function authenticateUser() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error al autenticar:", error);
                showModal("Error al autenticar: " + error.message);
            }
        }

        // Escuchador del estado de autenticación
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userDisplay.textContent = `ID de Usuario: ${userId}`;
                loadingIndicator.classList.add('hidden');
                
                // Configurar el listener de Firestore
                const forecastsCollectionPath = `artifacts/${appId}/public/data/forecasts`;
                const q = collection(db, forecastsCollectionPath);

                onSnapshot(q, (querySnapshot) => {
                    const forecasts = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        forecasts.push({ id: doc.id, ...data });
                    });

                    // Ordenar por fecha en memoria (no se usa orderBy en la consulta de Firestore)
                    forecasts.sort((a, b) => new Date(b.date) - new Date(a.date));

                    renderForecasts(forecasts);
                }, (error) => {
                    console.error("Error al escuchar cambios en Firestore:", error);
                    showModal("Error al cargar pronósticos: " + error.message);
                });
            } else {
                console.log("No hay usuario autenticado.");
                loadingIndicator.classList.remove('hidden');
                await authenticateUser();
            }
        });

        // Función para renderizar los pronósticos
        function renderForecasts(forecasts) {
            forecastsList.innerHTML = '';
            if (forecasts.length === 0) {
                forecastsList.innerHTML = '<p class="text-gray-500 text-center">No hay pronósticos todavía.</p>';
                return;
            }
            
            forecasts.forEach(forecast => {
                const forecastItem = document.createElement('div');
                forecastItem.className = 'bg-white p-4 rounded-lg shadow-md mb-4 flex flex-col md:flex-row justify-between items-center';
                forecastItem.innerHTML = `
                    <div class="mb-2 md:mb-0">
                        <p class="text-lg font-semibold text-gray-800">${forecast.forecast}</p>
                        <p class="text-sm text-gray-500">Fecha: ${new Date(forecast.date).toLocaleDateString()}</p>
                        <p class="text-sm text-gray-500">Subido por: ${forecast.uploaderId}</p>
                    </div>
                `;
                forecastsList.appendChild(forecastItem);
            });
        }

        // Manejar el envío del formulario
        forecastForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) {
                showModal("El usuario no está autenticado. Por favor, inténtalo de nuevo.");
                return;
            }

            const newForecast = forecastInput.value.trim();
            if (newForecast === '') {
                showModal("Por favor, introduce un pronóstico.");
                return;
            }

            try {
                // Agregar el nuevo pronóstico a Firestore
                await addDoc(collection(db, `artifacts/${appId}/public/data/forecasts`), {
                    forecast: newForecast,
                    date: new Date().toISOString(),
                    uploaderId: userId
                });
                forecastInput.value = '';
                showModal("¡Pronóstico subido con éxito!");
            } catch (error) {
                console.error("Error al subir el pronóstico:", error);
                showModal("Error al subir el pronóstico: " + error.message);
            }
        });

        // Cerrar el modal
        closeModalButton.addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        // Autenticar al cargar la página
        authenticateUser();
    </script>
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #e2e8f0;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-900">
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-600 mb-2">Guacharo activo</h1>
            <p class="text-lg text-gray-600">Sube y ve los pronósticos en tiempo real.</p>
            <div id="user-display" class="mt-4 text-sm text-gray-500">Cargando usuario...</div>
        </header>
        
        <main class="bg-gray-50 p-6 rounded-3xl shadow-xl border border-gray-200">
            <!-- Formulario para subir un nuevo pronóstico -->
            <section class="mb-8">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Subir un Nuevo Pronóstico</h2>
                <form id="forecast-form" class="flex flex-col md:flex-row gap-4">
                    <input
                        type="text"
                        id="forecast-input"
                        placeholder="Escribe tu pronóstico de hoy..."
                        class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required
                    />
                    <button
                        type="submit"
                        class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ease-in-out transform hover:scale-105"
                    >
                        Subir Pronóstico
                    </button>
                </form>
            </section>
            
            <!-- Lista de pronósticos -->
            <section>
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Historial de Pronósticos</h2>
                <div id="loading-indicator" class="text-center text-blue-500">
                    <div class="animate-spin inline-block w-8 h-8 border-4 border-blue-500 border-solid rounded-full border-r-transparent"></div>
                    <p class="mt-2">Cargando pronósticos...</p>
                </div>
                <div id="forecasts-list" class="space-y-4 max-h-96 overflow-y-auto custom-scrollbar">
                    <!-- Los pronósticos se renderizarán aquí -->
                </div>
            </section>
        </main>
    </div>

    <!-- Modal personalizado para notificaciones -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center border-t-4 border-blue-500">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Notificación</h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <button id="close-modal" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-700 transition duration-300">
                Aceptar
            </button>
        </div>
    </div>
</body>
</html>
